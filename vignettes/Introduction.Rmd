---
title: "Introduction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this article we would like to give an example of how to create a very simple 
drill down map with `leafdown`. \
The goal is to create a map that:

-  shows the GDP (gross domestic product) of the federal states of Germany 
-  allows the user to drill down to the administrative districts.

TODO: Update picture


![](res/app_germany_map.png){width=250px, height=400px}

Let's first load the libraries we are going to use for our app. \

```{r setup, message=FALSE}
library(leafdown)
library(leaflet)
library(shiny)
library(dplyr)
library(shinyjs)
```

(Note that the `shinyjs` package is loaded for some automatic messages that the 
`leafdown` map can return to the user of the shiny app.)


## SpatialPolygonsDataFrames

`leafdown` requires a list of SpatialPolygonsDataFrames (spdfs) for the regions we would like to show.

For obtaining those spdfs we can use e.g. the `getData` function of the `raster` package.
If we select "Germany" as country, level 1 contains the spdf for the federal states
and level 2 the spdf the administrative districts.

```{r, echo=FALSE}
ger1 <- readRDS("../inst/extdata/gadm36_DEU_1_sp.rds")
ger2 <- readRDS("../inst/extdata/gadm36_DEU_2_sp.rds")
```

```{r, eval=FALSE}
ger1 <- raster::getData(country = "Germany", level = 1)
ger2 <- raster::getData(country = "Germany", level = 2)
```

The spdf for level 2 does not display all German umlauts correctly. Therefore we adapt 
some names so that we can assign our data easier later on.
```{r, message=FALSE}
ger2@data[c(76, 99, 136, 226), "NAME_2"] <- c(
  "Fürth (Kreisfreie Stadt)",
  "München (Kreisfreie Stadt)",
  "Osnabrück (Kreisfreie Stadt)",
  "Würzburg (Kreisfreie Stadt)"
)
```

Let's now build our `spdfs_list` which we can provide to `leafdown` in our shiny app.
It is important that `spdfs_list` is ordered such that the spdf of highest map level 
(in our case the federal states) is the first element and so on.

```
list (spdfs_list)
│   
└───spdf (spdf of first map level)
│
└───spdf (spdf of second map level)

```

```{r}
spdfs_list <- list(ger1, ger2)
```


## Data

For this app we will use the example data sets that come with the `leafdown` package.
The data.frame `gdp_2014_federal_states`  contains the GPD of 2014 for the federal 
states and `gdp_2014_admin_districts` for the administrative districts of Germany.

```{r}
head(gdp_2014_federal_states)
```

```{r}
head(gdp_2014_admin_districts)
```

(For more information on the data please see `?gdp_2014_federal_states` or
`?gdp_2014_admin_districts` respectively)



## Leafdown workflow
In this part we give a sketch of the `leafdown` workflow.

As usual for R6 classes, we create a new object of our `Leafdown` class using the
`new()` method. \
Here we have to specify the:

- `spdfs_list`: The list containing the spdfs of both map levels.
- `map_output_id`: The output_id we specify in our ui via `leafletOutput("<<map_output_id>>")`
- `input`: The `input` from the shiny app

### Initialization
```{r}
input <- reactiveValues(foo = "bar") # a little helper as we are currently not in a shiny session
my_leafdown <- Leafdown$new(spdfs_list, map_output_id = "leafdown", input = input)
```

In the next step we add data to our map.
Using the method `$get_current_metadata()` we can obtain the metadata of the (displayed)
regions of the current map level.
As metadata we refer to the data that describe the polygons such as region names, 
region ids etc.
(Essentially we refer to metadata as what is obtained by calling e.g. `ger1@data`)

```{r}
data <- my_leafdown$get_current_metadata()
print(head(data))
```

Now we can add new columns (with data we want to show in our app) to the existing metadata.
e.g. by using a left join.
It is important that the initial metadata of the data.frame retrieved from `$get_current_data()` 
are unchanged and no rows are removed.

```{r}
new_data <- data %>% left_join(gdp_2014_federal_states, by = c("NAME_1" = "Federal_State"))
```

After creating our new data set we give this to our `my_leafdown` with the `$add_data` method.
```{r}
my_leafdown$add_data(new_data)
```

The current data of `my_leafdown` can be retrieved using the `curr_data` attribute.
```{r}
print(head(my_leafdown$curr_data))
```


Finally we can use the method `$draw_leafdown` to draw the map.
The specified arguments are internally handed over to the `addPolygons` of `leaflet` 
which makes it possible to use
all the great `leaflet` features such as a legend or a map background just
as in the usual leaflet maps.


The `$draw_leafdown()` method returns a normal `leaflet` object. Therefore we 
can also add a legend or a map background as in the usual leaflet maps.

```{r, eval=FALSE}
my_leafdown$draw_leafdown(
  fillColor = ~ colorNumeric("Blues", GDP_2014)(GDP_2014)
) %>% addTiles() # Add map background
```

### Drilldown

Using the `$drill_down` method we can now drill down to the admin districts of
the selected federal states.

```{r, eval=FALSE}
my_leafdown$drill_down()
```


This will update the currently active spdf (`my_leafdown$curr_spdf`).
This spdf will only contain polygons and corresponding metadata for regions
which parents were selected in the upper (previous) map level.
Example:

- We selected the federal states "Bavaria" and "Hesse" in the first map level
- After the drilldown the currently active spdf will then only contain the 
admin districts of "Bavaria" and "Hesse" but non of the other federal states.

Note that the initial `spdf_list` (`my_leafdown$spdfs_list`) remains unchanged
such that we can drill down and up multiple times without the need of specifying
`spdf_list` again.

The updated metadata can then again retrieved via `$get_current_metadata()`.
```{r eval = FALSE}
my_leafdown$drill_down()
data <- my_leafdown$get_current_metadata()
print(head(data))
```

TODO: Change this to show Bavaria data
```{r echo=FALSE}
print(head(ger2@data))
```


Now we can again add new data as described above and draw the our map.
```{r, eval=FALSE}
my_leafdown$drill_down()
data <- my_leafdown$get_current_metadata()
data <- data %>% left_join(gdp_2014_admin_districts, by = c("NAME_2" = "Admin_District"))
my_leafdown$add_data(new_data)
my_leafdown$draw_leafdown(
  fillColor = ~ colorNumeric("Blues", GDP_2014)(GDP_2014)
)
```




### Drillup

TO DO: Explain drill-down and drill up functionality
Drilldown

- updates the spdf and the metadata
- at the new map level the new spdf only contains polygons and data of regions 
which parents were selected in the upper map level. 
- Note that the initial spdf_list remains unchanged.

```{r}
new_data <- data %>% left_join(gdp_2014_federal_states, by = c("NAME_1" = "Federal_State"))
```

## Shiny App

Let's now define a very basic UI with only two buttons for drilldown and 
drillup and the `leaflet` UI element in which we can render our `leafdown` map.

### UI
```{r, eval=FALSE}
ui <- shiny::fluidPage(
  tags$style(HTML(".leaflet-container {background: #ffffff;}")),
  useShinyjs(),
  actionButton("drill_down", "Drill Down"),
  actionButton("drill_up", "Drill Up"),
  leafletOutput("leafdown", height = 600),
)
```

### Server

```{r}
create_labels <- function(data, map_level) {
  labels <- sprintf(
    "<strong>%s</strong><br/>%g € per capita</sup>",
    data[, paste0("NAME_", map_level)], data$GDP_2014
  )
  labels %>% lapply(htmltools::HTML)
}
```


```{r, eval=FALSE}
server <- function(input, output) {
  my_leafdown <- Leafdown$new(spdfs_list, "leafdown", input)
  update_leafdown <- reactiveVal(0)

  observeEvent(input$drill_down, {
    my_leafdown$drill_down()
    update_leafdown(update_leafdown() + 1)
  })

  observeEvent(input$drill_up, {
    my_leafdown$drill_up()
    update_leafdown(update_leafdown() + 1)
  })

  output$leafdown <- renderLeaflet({
    update_leafdown()
    data <- my_leafdown$get_current_metadata()
    curr_map_level <- my_leafdown$curr_map_level
    if (curr_map_level == 1) {
      data <- data %>% left_join(gdp_2014_federal_states, by = c("NAME_1" = "Federal_State"))
    } else {
      data <- data %>% left_join(gdp_2014_admin_districts, by = c("NAME_2" = "Admin_District"))
    }

    my_leafdown$add_data(data)
    labels <- create_labels(data, curr_map_level)
    my_leafdown$draw_leafdown(
      fillColor = ~ colorNumeric("Blues", GDP_2014)(GDP_2014),
      weight = 2, fillOpacity = 0.8, color = "grey", label = labels,
      highlight = highlightOptions(weight = 5, color = "#666", fillOpacity = 0.7)
    ) %>%
      addLegend("topright",
        pal = colorNumeric("Blues", data$GDP_2014),
        values = data$GDP_2014,
        title = "Est. GDP (2014)",
        labFormat = labelFormat(suffix = "€"),
        opacity = 1
      )
  })
}
```

### Run App
```{r, eval=FALSE}
shinyApp(ui, server)
```

<style>
.shiny-app-frame {
  position: relative;
  height: 700px;
}
.shiny-app-frame iframe {
  width: 100%;
  height: 100%;
  border: none;
}
</style>

<br>
<div class="shiny-app-frame"> 
<iframe src="https://andreasho95.shinyapps.io/leafdown-basic-example/">
</iframe>
</div>



